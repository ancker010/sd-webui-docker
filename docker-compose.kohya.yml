version: "3.8"
name: kohya-ss

services:
  kohya:
    image: ghcr.io/neggles/kohya-ss-docker:latest
    restart: unless-stopped
    container_name: kohya-ss
    build:
      context: ./docker
      dockerfile: Dockerfile
      target: kohya
    environment:
      CLI_ARGS: "--listen 0.0.0.0"
      KOHYA_PORT: 7681
      # make TQDM behave a little better
      PYTHONUNBUFFERED: "1"
      TERM: "${TERM}"
      # Set to your local cuda version's install path, and update the bind mount below
      CUDA_HOME: "/usr/local/cuda-12.0"
    ports:
      - mode: ingress
        target: 7681
        published: 7681
        protocol: tcp
      - mode: ingress
        target: 6006
        published: 6006
        protocol: tcp
    volumes:
      - type: bind
        source: ./data
        target: /data
      # you will need to set this to your local cuda version install path for bitsandbytes to work right
      - type: bind
        source: /usr/local/cuda-12.0
        target: /usr/local/cuda-12.0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [ gpu ]
              device_ids: [ "0" ]
